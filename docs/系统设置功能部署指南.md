# CodeShare 系统设置功能部署指南

## 概述

本指南为系统管理员提供 CodeShare 系统设置功能的完整部署说明，包括环境要求、安装步骤、配置选项和维护建议。

## 目录

1. [系统要求](#系统要求)
2. [部署前准备](#部署前准备)
3. [数据库迁移](#数据库迁移)
4. [应用程序配置](#应用程序配置)
5. [权限设置](#权限设置)
6. [功能验证](#功能验证)
7. [监控和维护](#监控和维护)
8. [故障排除](#故障排除)
9. [备份和恢复](#备份和恢复)

## 系统要求

### 服务器要求
- **操作系统**：Windows Server 2016+ / Linux Ubuntu 18.04+ / CentOS 7+
- **CPU**：2 核心或更高
- **内存**：4GB RAM 或更高
- **存储**：20GB 可用空间

### 软件要求
- **.NET 8.0 Runtime**：ASP.NET Core 8.0 运行时
- **数据库**：MySQL 8.0+ 或 MariaDB 10.5+（生产环境）
- **Web 服务器**：IIS 10+ / Nginx / Apache
- **反向代理**：推荐使用 Nginx 或 IIS

### 开发环境要求
- **IDE**：Visual Studio 2022 或 VS Code
- **.NET SDK**：.NET 8.0 SDK
- **Node.js**：Node.js 18+（前端开发）
- **Git**：Git 2.0+

## 部署前准备

### 1. 代码准备
```bash
# 克隆代码仓库
git clone <repository-url>
cd CodeShare

# 切换到正确分支
git checkout main

# 拉取最新代码
git pull origin main
```

### 2. 环境配置
```bash
# 后端环境配置
cd backend
dotnet restore

# 前端环境配置
cd ../frontend
npm install
```

### 3. 数据库准备
确保数据库服务器已安装并运行：
```bash
# MySQL
mysql -u root -p -e "CREATE DATABASE codeshare CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 创建数据库用户
mysql -u root -p -e "CREATE USER 'codeshare'@'localhost' IDENTIFIED BY 'your_password';"
mysql -u root -p -e "GRANT ALL PRIVILEGES ON codeshare.* TO 'codeshare'@'localhost';"
mysql -u root -p -e "FLUSH PRIVILEGES;"
```

### 4. 配置文件准备
创建 `appsettings.Production.json` 文件：
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=codeshare;User=codeshare;Password=your_password;",
    "SQLiteConnection": "Data Source=codeshare.db"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "JwtSettings": {
    "SecretKey": "your-jwt-secret-key-here",
    "Issuer": "CodeShare",
    "Audience": "CodeShareUsers",
    "ExpirationMinutes": 720
  }
}
```

## 数据库迁移

### 1. 运行迁移脚本
选择适合您数据库类型的迁移脚本：

#### MySQL 环境
```bash
# 进入迁移脚本目录
cd backend/Data/Migrations

# 执行 MySQL 迁移
mysql -u codeshare -p codeshare < SystemSettingsMigration_v1.0.0.sql
```

#### SQLite 环境
```bash
# 进入迁移脚本目录
cd backend/Data/Migrations

# 执行 SQLite 迁移
sqlite3 ../../codeshare.db < SystemSettingsMigration_v1.0.0_Sqlite.sql
```

### 2. 验证迁移结果
```sql
-- 检查表是否创建成功
SHOW TABLES LIKE 'SystemSettings';
SHOW TABLES LIKE 'SettingsHistory';
SHOW TABLES LIKE 'ShareTokens';
SHOW TABLES LIKE 'ShareAccessLogs';

-- 检查默认数据
SELECT COUNT(*) FROM SystemSettings;
```

### 3. 回滚（如需要）
如果迁移出现问题，可以执行回滚脚本：
```bash
# MySQL 回滚
mysql -u codeshare -p codeshare < SystemSettingsRollback_v1.0.0.sql

# SQLite 回滚
sqlite3 ../../codeshare.db < SystemSettingsRollback_v1.0.0_Sqlite.sql
```

## 应用程序配置

### 1. 后端配置
```bash
cd backend

# 发布应用程序
dotnet publish -c Release -o ../publish

# 或创建自包含部署
dotnet publish -c Release -r win-x64 -o ../publish-self-contained --self-contained true
```

### 2. 前端构建
```bash
cd frontend

# 构建生产版本
npm run build

# 或构建预览版本
npm run preview
```

### 3. 环境变量配置
设置必要的环境变量：

#### Windows
```cmd
set ASPNETCORE_ENVIRONMENT=Production
set ConnectionStrings__DefaultConnection=Server=localhost;Database=codeshare;User=codeshare;Password=your_password;
```

#### Linux
```bash
export ASPNETCORE_ENVIRONMENT=Production
export ConnectionStrings__DefaultConnection="Server=localhost;Database=codeshare;User=codeshare;Password=your_password;"
```

### 4. 服务配置
#### Windows 服务安装
```powershell
# 创建 Windows 服务
sc create CodeShare binPath= "C:\path\to\publish\CodeSnippetManager.Api.exe"
sc description CodeShare "CodeShare API Service"

# 启动服务
sc start CodeShare
```

#### Linux 服务安装
```bash
# 创建 systemd 服务文件
sudo nano /etc/systemd/system/codeshare.service
```

服务文件内容：
```ini
[Unit]
Description=CodeShare API Service
After=network.target

[Service]
WorkingDirectory=/var/www/codeshare
ExecStart=/usr/bin/dotnet /var/www/codeshare/CodeSnippetManager.Api.dll
Restart=always
RestartSec=10
SyslogIdentifier=codeshare
User=www-data
Environment=ASPNETCORE_ENVIRONMENT=Production
Environment=ConnectionStrings__DefaultConnection=Server=localhost;Database=codeshare;User=codeshare;Password=your_password;

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable codeshare
sudo systemctl start codeshare
```

## 权限设置

### 1. 文件系统权限
```bash
# 设置 Web 根目录权限
sudo chown -R www-data:www-data /var/www/codeshare
sudo chmod -R 755 /var/www/codeshare

# 设置上传目录权限
sudo mkdir -p /var/www/codeshare/uploads
sudo chmod -R 775 /var/www/codeshare/uploads
```

### 2. 数据库权限
确保应用程序用户具有必要的数据库权限：
```sql
-- 授予必要的权限
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, ALTER, INDEX ON codeshare.* TO 'codeshare'@'localhost';
GRANT EXECUTE ON PROCEDURE codeshare.CleanupExpiredShareTokens TO 'codeshare'@'localhost';
GRANT EXECUTE ON PROCEDURE codeshare.GetShareStats TO 'codeshare'@'localhost';
```

### 3. 网络权限
确保防火墙允许必要的端口：
```bash
# Ubuntu/Debian
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload
```

## 功能验证

### 1. 基本功能检查
- [ ] 应用程序正常启动
- [ ] 数据库连接正常
- [ ] 用户认证功能正常
- [ ] 系统设置页面可访问
- [ ] 管理员权限正常

### 2. 系统设置功能验证
#### 站点设置
- [ ] 可以修改站点名称
- [ ] 可以上传 Logo 和 Favicon
- [ ] 可以保存站点设置
- [ ] 设置生效正常

#### 安全设置
- [ ] 可以配置密码策略
- [ ] 可以设置账户锁定策略
- [ ] 可以配置会话管理
- [ ] 安全设置生效正常

#### 功能设置
- [ ] 可以启用/禁用功能模块
- [ ] 可以配置限制参数
- [ ] 可以设置 API 参数
- [ ] 功能设置生效正常

#### 邮件设置
- [ ] 可以配置 SMTP 服务器
- [ ] 可以测试邮件连接
- [ ] 可以发送测试邮件
- [ ] 邮件设置生效正常

#### 设置历史
- [ ] 可以查看变更历史
- [ ] 筛选功能正常
- [ ] 导出功能正常
- [ ] 统计信息正确

#### 导入导出
- [ ] 可以导出设置
- [ ] 可以导入设置
- [ ] 数据验证正常
- [ ] 导入导出功能正常

### 3. 性能测试
- [ ] 页面加载时间 < 3秒
- [ ] 设置保存响应时间 < 2秒
- [ ] 数据库查询响应时间 < 1秒
- [ ] 并发用户支持正常

## 监控和维护

### 1. 应用程序监控
```bash
# 检查服务状态
sudo systemctl status codeshare

# 查看应用程序日志
sudo journalctl -u codeshare -f

# 检查端口占用
sudo netstat -tlnp | grep :5000
```

### 2. 数据库监控
```sql
-- 检查数据库连接数
SHOW STATUS LIKE 'Threads_connected';

-- 检查慢查询
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';

-- 检查表大小
SELECT table_name, table_rows, data_length, index_length 
FROM information_schema.tables 
WHERE table_schema = 'codeshare'
ORDER BY data_length DESC;
```

### 3. 定期维护任务
#### 清理过期分享令牌
```sql
-- 手动清理过期分享令牌
CALL CleanupExpiredShareTokens();

-- 或设置定时任务（MySQL 事件）
CREATE EVENT IF NOT EXISTS cleanup_expired_tokens
ON SCHEDULE EVERY 1 DAY
STARTS CURRENT_TIMESTAMP
DO
    CALL CleanupExpiredShareTokens();
```

#### 清理设置历史
```sql
-- 清理超过1年的设置历史
DELETE FROM SettingsHistory 
WHERE CreatedAt < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

#### 数据库优化
```sql
-- 分析表
ANALYZE TABLE SystemSettings;
ANALYZE TABLE SettingsHistory;
ANALYZE TABLE ShareTokens;
ANALYZE TABLE ShareAccessLogs;

-- 优化表
OPTIMIZE TABLE SystemSettings;
OPTIMIZE TABLE SettingsHistory;
OPTIMIZE TABLE ShareTokens;
OPTIMIZE TABLE ShareAccessLogs;
```

### 4. 日志管理
配置日志轮转：
```bash
# 创建日志轮转配置
sudo nano /etc/logrotate.d/codeshare
```

配置内容：
```
/var/log/codeshare/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload codeshare
    endscript
}
```

## 故障排除

### 1. 应用程序无法启动
**可能原因：**
- 端口被占用
- 数据库连接失败
- 配置文件错误

**解决方法：**
```bash
# 检查端口占用
sudo netstat -tlnp | grep :5000

# 检查数据库连接
mysql -u codeshare -p -e "SELECT 1;"

# 检查配置文件
dotnet run --configuration Release --dry-run
```

### 2. 数据库连接失败
**可能原因：**
- 数据库服务未启动
- 连接字符串错误
- 权限不足

**解决方法：**
```bash
# 检查数据库服务
sudo systemctl status mysql

# 测试数据库连接
mysql -u codeshare -p codeshare -e "SELECT 1;"

# 检查连接字符串
echo $ConnectionStrings__DefaultConnection
```

### 3. 权限错误
**可能原因：**
- 文件权限不正确
- 数据库权限不足
- 用户权限配置错误

**解决方法：**
```bash
# 检查文件权限
ls -la /var/www/codeshare

# 检查数据库权限
SHOW GRANTS FOR 'codeshare'@'localhost';

# 检查用户权限
id www-data
```

### 4. 性能问题
**可能原因：**
- 数据库查询慢
- 内存不足
- 磁盘空间不足

**解决方法：**
```bash
# 检查系统资源
htop
df -h

# 检查数据库性能
SHOW PROCESSLIST;
SHOW STATUS LIKE 'Slow_queries';

# 检查应用程序日志
sudo journalctl -u codeshare --since "1 hour ago"
```

## 备份和恢复

### 1. 数据库备份
```bash
# 创建备份脚本
nano /usr/local/bin/backup-codeshare.sh
```

备份脚本内容：
```bash
#!/bin/bash

# 配置
DB_NAME="codeshare"
DB_USER="codeshare"
DB_PASS="your_password"
BACKUP_DIR="/var/backups/codeshare"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/codeshare_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/codeshare_$DATE.sql

# 保留最近30天的备份
find $BACKUP_DIR -name "codeshare_*.sql.gz" -mtime +30 -delete

echo "Backup completed: $BACKUP_DIR/codeshare_$DATE.sql.gz"
```

设置执行权限：
```bash
sudo chmod +x /usr/local/bin/backup-codeshare.sh
```

设置定时任务：
```bash
sudo crontab -e
```

添加定时任务：
```
0 2 * * * /usr/local/bin/backup-codeshare.sh
```

### 2. 应用程序备份
```bash
# 备份应用程序文件
sudo tar -czf /var/backups/codeshare/app_$(date +%Y%m%d_%H%M%S).tar.gz -C /var/www/codeshare .

# 备份配置文件
sudo cp /etc/systemd/system/codeshare.service /var/backups/codeshare/
sudo cp /etc/nginx/sites-available/codeshare /var/backups/codeshare/
```

### 3. 恢复操作
```bash
# 恢复数据库
mysql -u codeshare -p codeshare < /var/backups/codeshare/codeshare_YYYYMMDD_HHMMSS.sql

# 恢复应用程序文件
sudo tar -xzf /var/backups/codeshare/app_YYYYMMDD_HHMMSS.tar.gz -C /var/www/codeshare

# 重启服务
sudo systemctl restart codeshare
```

## 安全建议

### 1. 网络安全
- 使用 HTTPS 加密连接
- 配置防火墙规则
- 限制数据库访问
- 使用 VPN 进行远程管理

### 2. 应用安全
- 定期更新依赖包
- 使用强密码策略
- 启用双因素认证
- 定期审计日志

### 3. 数据安全
- 加密敏感数据
- 定期备份数据
- 限制数据访问权限
- 监控数据访问

## 联系支持

如果在部署过程中遇到问题，请：

1. 查看本文档的故障排除部分
2. 检查应用程序日志
3. 查看数据库日志
4. 联系技术支持团队

## 版本信息

- **系统设置功能版本**：v1.0.0
- **部署指南版本**：v1.0.0
- **最后更新**：2025-01-01

---

© 2025 CodeShare. 保留所有权利。